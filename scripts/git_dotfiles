#!/bin/bash

# colors
RED='\x1b[38;2;232;36;36m'     #E82424
YELLOW='\x1b[38;2;255;158;59m' #FF9E3B

# clone the repo if it is not in ~/.config ans cd into it
[[ -d ~/.config/dotfiles ]] || git clone https://github.com/anonymousgrasshopper/dotfiles ~/.config/dotfiles
cd ~/.config/dotfiles || {
	echo "${RED}Cloning the GitHub repository failed. Check you internet connection and try again"
	exit
}

# $1: file to copy relative to ~/.config/dotfiles, $2: destination
copy_file() {
	[[ -e "$1" ]] || {
		echo -e "${YELLOW}ï± $1 not found"
		return 1
	}
	if [[ -d "$1" ]]; then
		[[ -d "configs/$(basename "$1")" ]] && rm -rf "configs/$(basename "$1")"
		cp -r "$1" "$2/" 2>/dev/null
	else
		cp "$1" "$2/" 2>/dev/null
	fi
}

# list of configs and scripts to copy
configs=("bat" "btop" "browser" "eza" "fastfetch" "formatters" "git" "i3" "kitty"
	"lazygit" "mutt" "ncdu" "npm" "nvim" "rofi" "thundery" "tmux" "wallpapers" "wget"
	"yazi" "zathura" "zsh" "fzf.conf" "mimeapps.list" "ripgrep.conf" "shellcheckrc")
scripts=("assemble" "codelldb_stdio_redirection" "compile_sfml" "fix_corrupt_history"
	"fzf_preview_wrapper" "git_dotfiles" "remove_codelldb_stdio_redirection")

# overwrite configs in the dotfiles repo
for config in ${configs[@]}; do
	copy_file "$HOME/.config/$config" "configs/"
done
# overwrite scripts in the dotfiles repo
for script in ${scripts[@]}; do
	copy_file "$HOME/.local/bin/$script" "scripts"
done
# overwrite dbg.h
copy_file "$CPLUS_INCLUDE_PATH/dbg.h" "etc"

# remove chosen files and directories
[[ -f configs/zsh/.zcompdump ]] && rm configs/zsh/.zcompdump
find configs/mutt/accounts -regex "\S*@\S*" -type f -delete
# hide email adresses
[[ -f configs/mutt/muttrc ]] && {
	sed -i 's:\(source .*/\)\S*@\S*\(<enter>;<check-stats>. "switch to \)\S*@\S*\("\):\1example@mail.com\2example@mail.com\3:' configs/mutt/muttrc
	sed -i 's:\(source .*/\)\S*@\S*\( # primary account\):\1example@mail.com\2:' configs/mutt/muttrc
}

# add everything to the index
git add .

# commit if args are passed to the scripts
if [[ $# == 2 ]]; then
	git commit -m"$1" -m"$2"
	git push
elif [[ $# == 1 ]]; then
	git commit -m"$1"
	git push
fi
